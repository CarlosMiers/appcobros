<ion-header class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="dismiss()" class="back-button">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="header-title">{{titulo}}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" color="light" (click)="imprimirFactura(venta)" *ngIf="venta.idventa > 0">
        <ion-icon name="print-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="content-background">
  <ion-card class="main-card fade-in-up">
    <ion-card-header class="card-header-icon">
      <ion-icon name="receipt-outline"></ion-icon>
      <ion-card-title>Información de la Venta</ion-card-title>
    </ion-card-header>
    <ion-card-content class="card-content-grid">
      <ion-grid>
        <ion-row>
          <ion-col size="12">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Factura</ion-label>
              <ion-input type="text" [(ngModel)]="venta.formatofactura" class="form-input" disabled></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Fecha</ion-label>
              <ion-input type="date" [(ngModel)]="venta.fecha" class="form-input"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Comprobante</ion-label>
              <ion-select [(ngModel)]="venta.comprobante" class="form-input custom-select">
                <ion-select-option [value]="1">Contado</ion-select-option>
                <ion-select-option [value]="2">Crédito</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">N° Preventa</ion-label>
              <ion-input type="text" [(ngModel)]="venta.preventa" (ionChange)="ValidarPreventa()" class="form-input" placeholder="Opcional"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12">
            <ion-button expand="block" color="tertiary" (click)="abrirBusquedaPreventa()" class="action-button-search">
              <ion-icon name="search-outline"></ion-icon>
              Buscar Preventa
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>

      <div class="divider-line"></div>

      <ion-item lines="none" class="ion-no-padding">
        <ion-label position="stacked">Cliente</ion-label>
        <ion-input type="text" [(ngModel)]="venta.cliente" class="form-input"></ion-input>
      </ion-item>
      <ion-button expand="block" color="tertiary" (click)="ValidarCliente()" class="action-button-search">
        <ion-icon name="search-outline"></ion-icon>
        Buscar Cliente
      </ion-button>

      <div class="client-info-container">
        <ion-text class="client-name">{{ venta.clienteNombre }}</ion-text>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card class="products-card fade-in-up">
    <ion-card-header class="card-header-icon">
      <ion-icon name="basket-outline"></ion-icon>
      <ion-card-title>Productos en la Factura</ion-card-title>
    </ion-card-header>
    <ion-card-content class="card-content-list">
      <ion-list lines="none" *ngIf="detalles.length > 0">
        <ion-item-sliding *ngFor="let detalle of detalles; let i = index">
          <ion-item class="product-item">
            <div class="product-info-wrapper">
              <ion-label class="ion-text-wrap">
                <p class="product-description">{{ detalle.descripcion }}</p>
                <p class="product-details">
                  Cód: <strong>{{ detalle.codprod }}</strong> |
                  Precio: <strong>{{ detalle.precio | number:'1.0-0' }}</strong>
                </p>
              </ion-label>
              <div class="item-total">
                <span class="quantity">x{{ detalle.cantidad }}</span>
                <span class="subtotal">{{ (detalle.precio * detalle.cantidad) | number:'1.0-0' }}</span>
              </div>
            </div>
          </ion-item>
          <ion-item-options side="end">
            <ion-item-option color="secondary" (click)="editarProducto(i)">
              <ion-icon name="create-outline" slot="icon-only"></ion-icon>
            </ion-item-option>
            <ion-item-option color="danger" (click)="eliminarProducto(i)">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>

      <div class="empty-state-list" *ngIf="detalles.length === 0">
        <ion-icon name="bag-add-outline"></ion-icon>
        <p>Aún no hay productos añadidos.</p>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card class="add-product-card fade-in-up">
    <ion-card-header class="card-header-icon">
      <ion-icon name="add-circle-outline"></ion-icon>
      <ion-card-title>Añadir Producto</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Código de Producto</ion-label>
              <ion-input [(ngModel)]="codigoProductoSeleccionado" class="form-input"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
      <ion-button expand="block" color="tertiary" (click)="ValidarProducto()" class="action-button-search">
        <ion-icon name="search-outline"></ion-icon>
        Buscar Producto
      </ion-button>

      <div class="product-selected-info">
        <ion-text color="primary">{{ productoSeleccionado.descripcion }}</ion-text>
      </div>

      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Cantidad</ion-label>
              <ion-input [(ngModel)]="productoSeleccionado.cantidad" type="number" class="form-input"></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="6">
            <ion-item class="ion-no-padding" lines="none">
              <ion-label position="stacked">Precio</ion-label>
              <ion-input [(ngModel)]="productoSeleccionado.precio" type="number" class="form-input"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-button expand="block" color="success" (click)="agregarProducto()" class="add-button">
        <ion-icon name="add-outline"></ion-icon>
        Agregar Producto
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-grid class="total-grid">
    <ion-row class="ion-align-items-center">
      <ion-col size="6">
        <ion-text class="total-label">Total</ion-text>
      </ion-col>
      <ion-col size="6" class="ion-text-right">
        <ion-text class="total-value">{{totalVenta() | number:'1.0-0' }}</ion-text>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>

<ion-footer class="ion-no-border footer-buttons">
  <ion-grid>
    <ion-row>
      <ion-col size="6">
        <ion-button expand="block" color="success" (click)="guardarVenta()">
          <ion-icon name="save-outline"></ion-icon>
          Guardar
        </ion-button>
      </ion-col>
      <ion-col size="6">
        <ion-button expand="block" color="medium" (click)="dismiss()">
          <ion-icon name="arrow-back-outline"></ion-icon>
          Regresar
        </ion-button>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-footer>